<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DTR Generator</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      font-size: 11px;
      margin: 0;
      padding: 10px;
    }

    .page {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(2, auto);
      gap: 5px;
      height: 100%;
    }

    .dtr {
      padding: 4px;
      font-size: 9px;
      display: flex;
      flex-direction: column;
      height: 6.2in;
      box-sizing: border-box;
    }

    h5, h2, h4 {
      text-align: center;
      margin: 2px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 5px;
    }
    table, th, td {
      border: 1px solid #000;
    }
    th, td {
      padding: 2px;
      text-align: center;
    }
    th {
      background: #f0f0f0;
    }

    tbody td:first-child,
    tbody td:nth-child(6),
    tbody td:nth-child(7) {
      font-size: 9px;
      font-weight: normal;
    }

    tbody td:nth-child(2),
    tbody td:nth-child(3),
    tbody td:nth-child(4),
    tbody td:nth-child(5) {
      font-size: 12px;
      font-weight: bold;
    }

    .footer {
      margin-top: 5px;
      text-align: center;
      font-size: 10px;
    }
    .signature {
      margin-top: 15px;
      text-align: center;
      font-size: 10px;
    }
    .signature span {
      display: inline-block;
      border-top: 1px solid #000;
      padding: 0 15px;
    }
    .nothing {
      text-align: center;
      font-style: italic;
    }

    @media print {
      body {
        margin: 0;
        zoom: 80%;
      }
      @page {
        size: 8.5in 13in landscape;
        margin: 0;
      }
      .upload-box,
      button,
      input[type="file"] {
        display: none !important;
      }
    }
  </style>
</head>
<body>

  <div class="upload-box d-flex flex-column align-items-center my-4">
    <label for="pdfUpload" class="form-label fw-bold">Upload your DTR PDF</label>
    <input type="file" id="pdfUpload" accept="application/pdf" class="form-control mb-3" style="max-width:300px;">
    <button class="btn btn-primary" onclick="window.print()">ðŸ–¨ Print All</button>
  </div>

  <div class="page" id="formsContainer">
    <!-- 4 forms will be inserted here -->
  </div>

  <!-- Progress Modal -->
  <div class="modal fade" id="progressModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <h5 class="modal-title text-center">Processing PDF...</h5>
        <div class="progress mt-3">
          <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
               role="progressbar" style="width: 0%">0%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <script>
    const fileInput = document.getElementById('pdfUpload');
    const formsContainer = document.getElementById('formsContainer');
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    const progressBar = document.getElementById('progressBar');

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      progressBar.style.width = "0%";
      progressBar.textContent = "0%";
      progressModal.show();

      const fileReader = new FileReader();
      fileReader.onload = async function() {
        const typedarray = new Uint8Array(this.result);
        const pdf = await pdfjsLib.getDocument(typedarray).promise;
        let textContent = '';

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const text = await page.getTextContent();
          text.items.forEach(item => textContent += item.str + ' ');

          // Update progress
          let percent = Math.round((i / pdf.numPages) * 100);
          progressBar.style.width = percent + "%";
          progressBar.textContent = percent + "%";
        }

        // Employee info
        let empName = "_____________________";
        let period = "For the month of _____________";

        // Get employee name
        const nameMatch = textContent.match(/Employee\s+(.*?)\s+Position/);
        if (nameMatch) empName = nameMatch[1];

        // Get month/day range
        const periodMatch = textContent.match(/Period\s+([A-Za-z0-9\s\-]+)/);
        if (periodMatch) period = periodMatch[1];

        // Extract year from any date in logs (format: MM/DD/YYYY)
        const yearMatch = textContent.match(/\d{2}\/\d{2}\/(\d{4})/);
        if (yearMatch) {
          const year = yearMatch[1];
          period = `${period} ${year}`; // append year
        };

        // Parse logs
        const rows = textContent.match(/\d{7}\s+\w+\s+\d{2}\/\d{2}\/\d{4}.*?(?=\d{7}|$)/gs) || [];
        let logsByDay = {};

        rows.forEach(r => {
          const parts = r.trim().split(/\s+/);
          const date = parts[2];
          const dayNum = parseInt(date.split('/')[1]);
          const timeStr = parts[3];
          const mode = parts[5];

          if (!logsByDay[dayNum]) logsByDay[dayNum] = { amIn: '', amOut: '', pmIn: '', pmOut: '' };

          let [hm, ap] = [parts[3], parts[4]];
          let [h, m] = hm.split(':').map(Number);
          if (ap === "PM" && h !== 12) h += 12;
          if (ap === "AM" && h === 12) h = 0;
          const hour24 = h;

          if (mode === "In") {
            if (hour24 < 12) logsByDay[dayNum].amIn = timeStr;
            else logsByDay[dayNum].pmIn = timeStr;
          } else if (mode === "Out") {
            if (hour24 < 13) logsByDay[dayNum].amOut = timeStr;
            else logsByDay[dayNum].pmOut = timeStr;
          }
        });

        // Build a single DTR form
        function buildForm() {
        let rowsHtml = "";
        let grandTotalMinutes = 0; // total for whole month

        // helper: convert "HH:MM" into total minutes (24hr support)
        function toMinutes(t, isPM = false) {
          if (!t) return null;
          let [h, m] = t.split(":").map(Number);
          if (isPM && h < 12) h += 12;
          return h * 60 + m;
        }

        for (let d = 1; d <= 31; d++) {
          const log = logsByDay[d] || {};

          let amMinutes = 0, pmMinutes = 0;

          // AM duration
          if (log.amIn && log.amOut) {
            const amInMin = toMinutes(log.amIn);
            const amOutMin = toMinutes(log.amOut);
            if (amOutMin > amInMin) amMinutes = amOutMin - amInMin;
          }

          // PM duration
          if (log.pmIn && log.pmOut) {
            const pmInMin = toMinutes(log.pmIn, true);
            const pmOutMin = toMinutes(log.pmOut, true);
            if (pmOutMin > pmInMin) pmMinutes = pmOutMin - pmInMin;
          }

          // total per day
          const totalMinutes = amMinutes + pmMinutes;
          grandTotalMinutes += totalMinutes;  // add to monthly total

          const totHrs = Math.floor(totalMinutes / 60);
          const totMins = totalMinutes % 60;

          rowsHtml += `
            <tr>
              <td>${d}</td>
              <td>${log.amIn || ''}</td>
              <td>${log.amOut || ''}</td>
              <td>${log.pmIn || ''}</td>
              <td>${log.pmOut || ''}</td>
              <td>${totHrs || ''} ${totMins || ''}</td>
              <td></td>
            </tr>`;
        }

        // compute grand total in hrs + mins
        const grandHrs = Math.floor(grandTotalMinutes / 60);
        const grandMins = grandTotalMinutes % 60;

        return `
          <div class="dtr">
            <h5 style="text-align:left;font-size:7px;">Civil Service Form No. 48</h5>
            <h2 style="text-align:center;font-size:11px;">DAILY TIME RECORD</h2>
            <h4 style="text-align:center;font-size:15px;font-weight: bold;text-decoration: underline;">${empName}</h4>
            <h4 style="text-align:center;font-size:7px;">Name</h4>
            <h4 style="text-align:left;font-size:11px;">For the month of <span style="text-decoration: underline;font-size:15px;">${period}</span></h4>
            <p style="text-align:left;font-size:10px;">Official hours for arrival (Regular days) <br> and departure (Saturdays & Sundays)</p>
            <table style="margin-top: -15px">
              <thead>
                <tr>
                  <th rowspan="2">DAY</th>
                  <th colspan="2">A.M.</th>
                  <th colspan="2">P.M.</th>
                  <th colspan="2">UNDERTIME</th>
                </tr>
                <tr>
                  <th>Arrival</th>
                  <th>Departure</th>
                  <th>Arrival</th>
                  <th>Departure</th>
                  <th>Hours</th>
                  <th>Mins.</th>
                </tr>
              </thead>
              <tbody>${rowsHtml}</tbody>
            </table>
            <p style="text-align:right;font-weight:bold;font-size:13px;">
              Total: ${grandHrs} hrs ${grandMins} mins
            </p>
            <div class="footer">
              <p>I certify on my honor that the above is a true and correct report of the hours of work performed, record of which was made during the time of arrival at and departure from office.</p>
            </div>
            <div class="signature">
              <span>${empName}</span>
              <div>Verified as to the prescribed office hours.</div>
              <div style="margin-top:20px;"><span>In-Charge</span></div>
            </div>
          </div>`;
      }





        // Generate 4 copies
        formsContainer.innerHTML = buildForm() + buildForm() + buildForm() + buildForm();

        // Hide modal when done
        progressModal.hide();
      };
      fileReader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
